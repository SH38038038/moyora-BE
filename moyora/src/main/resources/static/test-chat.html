<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>채팅 대시보드</title>
</head>
<body>
<h2>채팅 대시보드</h2>

<div>
    <textarea id="chatLog" cols="60" rows="15" readonly></textarea><br />
    <input type="text" id="messageInput" placeholder="메시지를 입력하세요" size="50" />
    <button onclick="sendMessage()">전송</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
    const token = localStorage.getItem("accessToken");
    if (!token) {
        alert("로그인이 필요합니다.");
        window.location.href = "/login.html";
    }

    // 쿼리 파라미터에서 roomId 추출
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('roomId');
    if (!roomId) {
        alert("채팅방 ID가 필요합니다.");
        throw new Error("채팅방 ID가 없습니다.");
    }

    // 기존 메시지 불러오기
    function loadChatHistory() {
        fetch(`/chatroom/${roomId}/messages`, {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => {
            if (!res.ok) throw new Error("메시지 불러오기 실패");
            return res.json();
        })
        .then(messages => {
            messages.forEach(msg => appendLog(`${msg.sender}: ${msg.content}`));
        })
        .catch(err => console.error("기존 메시지 로딩 오류:", err));
    }

    const socket = new SockJS("http://localhost:8080/ws-chat");
    const stompClient = Stomp.over(socket);

    stompClient.connect(
        { Authorization: "Bearer " + token },
        frame => {
            console.log("Connected: " + frame);
            appendLog("서버에 연결되었습니다.");

            loadChatHistory();

            stompClient.subscribe(`/topic/chatroom/${roomId}`, message => {
                const msg = JSON.parse(message.body);
                appendLog(`${msg.sender}: ${msg.content}`);
            });
        },
        error => {
            console.error("WebSocket 연결 오류:", error);
            alert("WebSocket 연결에 실패했습니다.");
        }
    );

    function sendMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content) return;

        stompClient.send(
            "/app/chat.send",
            {},
            JSON.stringify({ roomId: roomId, content: content })
        );

        input.value = "";
    }

    function appendLog(text) {
        const chatLog = document.getElementById("chatLog");
        chatLog.value += text + "\n";
        chatLog.scrollTop = chatLog.scrollHeight;
    }
</script>
</body>
</html>