<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사용자 인증 요청 관리</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h1 {
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f4f4f4;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .btn {
            margin-right: 5px;
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }

        .accept { background-color: #4CAF50; color: white; }
        .reject { background-color: #f44336; color: white; }
        .delete { background-color: #9e9e9e; color: white; }
        .details { background-color: #2196F3; color: white; }

        /* Modal Style */
        .modal {
            display: none;
            position: fixed;
            z-index: 99;
            padding-top: 80px;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            width: 400px;
            border-radius: 8px;
        }

        .modal-header {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-close {
            float: right;
            cursor: pointer;
            color: red;
        }

        textarea {
            width: 100%;
            height: 80px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h1>인증 요청 관리</h1>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>이메일</th>
        <th>상태</th>
        <th>신청 날짜</th>
        <th>동작</th>
    </tr>
    </thead>
    <tbody id="verification-table-body">
    <!-- 데이터가 여기에 삽입됨 -->
    </tbody>
</table>

<!-- 상세보기 모달 -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            인증 상세 정보 <span class="modal-close" onclick="closeModal('detailsModal')">X</span>
        </div>
        <div id="detailsContent">
            로딩 중...
        </div>
    </div>
</div>

<!-- 거절 사유 입력 모달 -->
<div id="rejectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            거절 사유 입력 <span class="modal-close" onclick="closeModal('rejectModal')">X</span>
        </div>
        <form id="rejectForm">
            <input type="hidden" id="rejectId">
            <label for="rejectReason">사유:</label>
            <textarea id="rejectReason" required></textarea>
            <br>
            <button type="submit" class="btn reject">제출</button>
        </form>
    </div>
</div>

<script>
    const API_BASE = '/api/verification';

    async function loadPendingVerifications() {
        const res = await fetch(`${API_BASE}/pending`);
        const data = await res.json();

        const tbody = document.getElementById('verification-table-body');
        tbody.innerHTML = '';

        data.data.forEach(item => {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.email}</td>
                <td>${item.status}</td>
                <td>${item.createdAt || '-'}</td>
                <td>
                    <button class="btn details" onclick="showDetails(${item.id})">상세</button>
                    <button class="btn accept" onclick="accept(${item.id})">수락</button>
                    <button class="btn reject" onclick="openRejectModal(${item.id})">거절</button>
                    <button class="btn delete" onclick="remove(${item.id})">삭제</button>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    async function showDetails(id) {
        openModal('detailsModal');
        const res = await fetch(`${API_BASE}/details/${id}`);
        const data = await res.json();

        const container = document.getElementById('detailsContent');
        const v = data.data;

        container.innerHTML = `
            <p><strong>ID:</strong> ${v.id}</p>
            <p><strong>이메일:</strong> ${v.email}</p>
            <p><strong>상태:</strong> ${v.status}</p>
            <p><strong>생년월일:</strong> ${v.birth || '-'}</p>
            <p><strong>신청일:</strong> ${v.createdAt || '-'}</p>
            <p><strong>이미지:</strong><br>
                ${v.imageUrl ? `<img src="${v.imageUrl}" alt="ID Image" style="max-width: 100%;">` : '없음'}
            </p>
        `;
    }

    async function accept(id) {
        if (!confirm("인증을 수락하시겠습니까?")) return;
        await fetch(`${API_BASE}/accept/${id}`, { method: 'PUT' });
        loadPendingVerifications();
    }

    function openRejectModal(id) {
        document.getElementById('rejectId').value = id;
        document.getElementById('rejectReason').value = '';
        openModal('rejectModal');
    }

    document.getElementById('rejectForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const id = document.getElementById('rejectId').value;
        const reason = document.getElementById('rejectReason').value;

        // 거절 API 확장 필요: PUT + body (사유 포함)
        await fetch(`${API_BASE}/reject/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: reason })
        });

        closeModal('rejectModal');
        loadPendingVerifications();
    });

    async function remove(id) {
        if (!confirm("인증 요청을 삭제하시겠습니까?")) return;
        await fetch(`${API_BASE}/delete/${id}`, { method: 'DELETE' });
        loadPendingVerifications();
    }

    function openModal(id) {
        document.getElementById(id).style.display = 'block';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    window.onload = loadPendingVerifications;
</script>
</body>
</html>
